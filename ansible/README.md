# Воспроизведения теста Ansible

## Необходимые условия
Сценарий Anbisle (`ansible/playbook.yml`) предполагает выполнение следующих условий: 
1. наличие сервера с OS Ubuntu 18.04, адрес которого указан в подразделе `[servers]` файла `ansible/inventory`.  
2. пользователь, указанный в пункте `remote_user` имеет право выполнять команды с правами суперпользователя (с помощью `sudo`).
3. запущенная на этом сервере служба ssh
4. публичный ключ ssh пользователя, выполняющего сценарий, размещен на сервере. 

## Пример развертывания тестовой среды с помощью QEMU и запуска Ansible

1. В рабочем каталоге создать образ образа тома:
   ```console
   qemu-img create -f qcow2 ubuntu.cow 4G
   ```

2. Поместить iso-образ сервера с Ubuntu OS (`ubuntu-18.04.6-live-server-amd64.iso`), и запустить виртуальную машину с ним:

   ```console
    qemu-system-x86_64 -cdrom ubuntu-18.04.6-live-server-amd64.iso -drive file=ubuntu.cow  -enable-kvm -m 2G -smp 2 -vga virtio 
   ```

3. Установить и настроить сервер следуя инструкциям (принять предложение установки openssh).
4. Создать пользователя `admin` с правами запуска команд суперпользователя.
5. Отключить виртуальную машину и перезапустить командой:
   ```console
   qemu-system-x86_64 -drive file=ubuntu.cow  -enable-kvm -m 2G -smp 2 -vga virtio -net nic,model=virtio -net user,hostfwd=tcp::2222-:22
   ```
   Это откроет доступ к ssh по 127.0.0.1:2222. Если при запуске добавить параметр `-snapshot` произведенные изменения будут временными (полезно для тестирования). 
7. Поместить в `.ssh/config` следующие настройки:
   ```
   Host ubuntu-vm
         HostName 127.0.0.1
         Port 2222
   ```
Теперь к хосту можно будет обращаться по адресу `ubuntu-vm`.

7. Создать ключи для подключения по ssh:
   ```console
   # ssh-keygen
   ```
   Это сгенерирует публичный и приватный ssh-ключи. В реальной ситуации желательно задать надёжный пароль. 

8. Разместить ключи на сервере для доступа к учетной записи админа:
   ```console
   ssh-copy-id admin@ubuntu-vm
   ```
   На вопрос о продолжении подключения ответить `yes`, по запросу ввести пароль. 
9.  Выполнить сценарий Ansible:
   ```console
   ansible-playbook -i ansible/inventory ansible/playbook.yml
   ```
  Убедиться, что сценарий сработал, можно по соответствующей сводке:
  ```
  PLAY RECAP ***************************************************
  192.168.10.10    : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0
  ```

